{{- if eq .chezmoi.os "windows" -}}
{{ template "pwsh_setup" . }}

$FontFolder = Join-Path $HOME "AppData\Local\Microsoft\Windows\Fonts"
$RegPath = "HKCU:\Software\Microsoft\Windows NT\CurrentVersion\Fonts"

if (-not (Test-Path $FontFolder)) {
    Log-Info "Font folder not found. Skipping registration."
    exit 0
}

Log-Working "Registering fonts in Windows Registry..."

$Fonts = Get-ChildItem -Path $FontFolder -Include *.ttf, *.otf -Recurse

foreach ($Font in $Fonts) {
    $Type = if ($Font.Extension -eq '.otf') { "OpenType" } else { "TrueType" }
    $ValueName = "$($Font.BaseName) ($Type)"
    
    $Existing = Get-ItemProperty -Path $RegPath -Name $ValueName -ErrorAction SilentlyContinue
    
    if ($null -eq $Existing) {
        Log-Info "Registering: $($Font.Name)"
        try {
            New-ItemProperty -Path $RegPath -Name $ValueName -Value $Font.Name -PropertyType String -ErrorAction Stop | Out-Null
        } catch {
            Log-Error "Failed to register $($Font.Name): $($_.Exception.Message)"
        }
    }
}

Log-Success "Font registration complete."
{{- end }}
