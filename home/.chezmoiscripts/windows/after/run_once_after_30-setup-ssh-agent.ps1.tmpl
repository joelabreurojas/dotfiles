{{- if eq .chezmoi.os "windows" -}}
{{ template "pwsh_setup" . }}

Log-Working "Configuring Windows SSH Agent Service..."
$sshAgent = Get-Service -Name ssh-agent -ErrorAction SilentlyContinue

if ($null -eq $sshAgent) {
    Log-Error "SSH Agent service not found. Ensure OpenSSH Client is installed."
    exit 1
}

if ($sshAgent.Status -ne 'Running' -or $sshAgent.StartType -ne 'Automatic') {
    try {
        Set-Service -Name ssh-agent -StartupType Automatic -ErrorAction Stop
        Start-Service -Name ssh-agent -ErrorAction Stop
        Log-Success "SSH Agent service is now active and set to Automatic."
    } catch {
        Log-Error "Admin rights needed for Service configuration. Run PS as Admin once."
    }
}

{{ $ssh_keys := .ssh_keys -}}
$keys = @(
{{- range $ssh_keys }}
    "$HOME\.ssh\{{ . }}",
{{- end }}
)

foreach ($key in $keys) {
    if (Test-Path $key) {
        Log-Info "Adding key: $key"
        ssh-add $key 2>$null
    }
}
{{- end }}
