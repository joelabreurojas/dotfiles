#!/bin/bash
{{- template "bash_loggers" . -}}
set -euo pipefail

{{- if eq .profile "minimal" -}}
log_info "Minimal profile detected. Skipping Bitwarden setup."
exit 0
{{- end }}

STATUS=$(bw status 2>/dev/null | jq -r .status || echo "missing")

if [[ "$STATUS" == "missing" ]]; then
    log_error "Bitwarden CLI not found or not responding."
    exit 1
fi

if [[ "$STATUS" == "unauthenticated" || "$STATUS" == "locked" ]]; then
    log_info "Bitwarden is $STATUS."

    {{- if .is_headless -}}
    log_error "Cannot interactively resolve in headless environment."
    exit 1
    {{- end }}

    [[ "$STATUS" == "unauthenticated" ]] && bw login
    [[ "$STATUS" == "locked" ]] && export BW_SESSION=$(bw unlock --raw)

fi

log_success "Bitwarden is ready."
